#!/bin/bash

# hyprwhspr - Hyprland-optimized voice dictation application
# Main launcher script

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGE_ROOT="$(dirname "$SCRIPT_DIR")"

# Set environment variables
export HYPRWHSPR_ROOT="$PACKAGE_ROOT"
export PYTHONPATH="$PACKAGE_ROOT/lib:$PYTHONPATH"

# Help handling: route any -h/--help or leading "help" to CLI help
for arg in "$@"; do
  if [[ "$arg" == "-h" || "$arg" == "--help" ]]; then
    exec python3 "$PACKAGE_ROOT/lib/cli.py" --help
  fi
done

if [[ "$1" == "help" ]]; then
  exec python3 "$PACKAGE_ROOT/lib/cli.py" --help
fi

# Subcommands: route to CLI if recognized
if [[ "$1" =~ ^(setup|config|waybar|systemd|status|model|validate)$ ]]; then
  exec python3 "$PACKAGE_ROOT/lib/cli.py" "$@"
fi

# Set up ROCm library path if ROCm is installed
if [ -d "/opt/rocm" ]; then
  ROCM_LIB_DIRS=""
  [ -d "/opt/rocm/lib" ] && ROCM_LIB_DIRS="/opt/rocm/lib"
  [ -d "/opt/rocm/lib64" ] && ROCM_LIB_DIRS="${ROCM_LIB_DIRS:+$ROCM_LIB_DIRS:}/opt/rocm/lib64"
  
  if [ -n "$ROCM_LIB_DIRS" ]; then
    export LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}${ROCM_LIB_DIRS}"
  fi
fi

# Default: run main application
exec python3 "$PACKAGE_ROOT/lib/main.py" "$@"
